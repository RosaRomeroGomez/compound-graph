!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lodash"),require("d3")):"function"==typeof define&&define.amd?define(["exports","lodash","d3"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).myLibrary={},e._,e.d3)}(this,(function(e,t,s){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=o(t);var n={createChart:(e,t,s,o={})=>{e.attr("width",t+"px"),e.attr("height",s+"px");const a=o.x1||0,n=o.y1||0,l=o.x2||t,i=o.y2||s;return e.attr("preserveAspectRatio","xMinYMin meet"),e.attr("viewBox",`${a} ${n} ${l} ${i}`),e.append("defs"),e},translate:(e,t)=>`translate(${e}, ${t})`,line:(e,t,s,o)=>"M"+e+","+t+"L"+s+","+o,pathFn:s.line().x((e=>e.x)).y((e=>e.y)),MARKER_VIEWBOX:"-5 -5 10 10",ARROW:"M 0,-3.25 L 5 ,0 L 0,3.25",ARROW_SHARP:"M 0,-3 L 5 ,0 L 0,3 L 1 0"};const l=["backgroundClick","backgroundDblClick","backgroundMouseEnter","backgroundMouseLeave","backgroundCtx","nodeClick","nodeDblClick","nodeMouseEnter","nodeMouseLeave","nodeCtx","nodeSave","edgeClick","edgeMouseEnter","edgeMouseLeave","edgeCtx"];const i=(e,t,s=0)=>{if(t(e,s),e.nodes){const o=s+1;for(let s=0;s<e.nodes.length;s++)i(e.nodes[s],t,o)}},r=e=>{let t=[],s=[];return i(e,((e,o)=>{o>0&&(t=t.concat(e)),e.edges&&(s=s.concat(e.edges))})),{nodes:t,edges:s}},d=n.pathFn.curve(s.curveBasis),c=(e,t)=>({x1:e.x1,y1:e.y1,x2:Math.max(e.x2,t.width),y2:Math.max(e.y2,t.height)});e.SVGRenderer=class extends class{constructor(){this.data={},this.registry={}}setData(e){this.data=e}setCallback(e,t){if(-1===l.indexOf(e))throw new Error("Failed to register callback, unknown name "+e);this.registry[e]=t}unsetCallback(e){delete this.registry[e]}initialize(e){throw new Error("Needs impl")}render(){throw new Error("Needs impl")}}{constructor(e){if(super(),this.options=e||{},this.options.renderMode=this.options.renderMode||"basic",this.options.useEdgeControl=this.options.useEdgeControl||!1,this.options.edgeControlOffsetType=this.options.edgeControlOffsetType||"percentage",this.options.edgeControlOffset=this.options.edgeControlOffset||.66,this.options.useDebugger=this.options.useDebugger||!1,this.adapter=this.options.adapter,this.parentEl=null,this.svgEl=null,this.chart=null,this.chartSize={width:1,height:1},this.layout=null,!e.el)throw new Error("options must provide an element for graph rendering");this.initialize(e.el),this.zoom=null,this.collapseTracker={},this.hiddenEdges={}}initialize(e){this.parentEl=e,this.chartSize.width=this.parentEl.clientWidth,this.chartSize.height=this.parentEl.clientHeight,this.svgEl=document.createElementNS("http://www.w3.org/2000/svg","svg"),(e=>{for(;e.firstChild;)e.removeChild(e.firstChild);return e})(this.parentEl).appendChild(this.svgEl),this.svgEl.style.userSelect="none"}setData(e){super.setData(e),this.layout=null}async render(){const e=this.options;if(this.layout||(this.layout=await this.runLayout()),this.chart){const e=0,t=0,o=this.layout.width,a=this.layout.height,n=c({x1:e,y1:t,x2:o,y2:a},this.chartSize);s.select(this.svgEl).attr("viewBox",`${n.x1} ${n.y1} ${n.x2} ${n.y2}`);s.select(this.svgEl).transition().call(this.zoom.transform,s.zoomIdentity);const l=Math.max(2,Math.floor(this.layout.width/this.chartSize.width));this.zoom.scaleExtent([.5,l])}else this.chart=this._createChart();this.buildDefs(),"basic"===e.renderMode?(this.renderNodes(),this.renderEdges()):(this.renderNodesDelta(),this.renderEdgesDelta()),e.useEdgeControl&&this.renderEdgeControls(),this._enableDrag(),e.useDebugger&&this.renderDebug(),this._enableInteraction()}buildDefs(){const e=s.select(this.svgEl),t=r(this.layout).edges;e.select("defs").selectAll(".edge-marker-end").remove(),e.select("defs").selectAll(".edge-marker-end").data(t).enter().append("marker").classed("edge-marker-end",!0).attr("id",(e=>`arrowhead-${e.data.source.replace(/\s/g,"")}-${e.data.target.replace(/\s/g,"")}`)).attr("viewBox",n.MARKER_VIEWBOX).attr("refX",2).attr("refY",0).attr("orient","auto").attr("markerWidth",15).attr("markerHeight",15).attr("markerUnits","userSpaceOnUse").attr("xoverflow","visible").append("svg:path").attr("d",n.ARROW).style("fill","#000").style("stroke","none")}renderEdgesDelta(){const e=this.chart;let t=[];i(this.layout,(e=>{e.edges&&e.edges.length>0&&(t=t.concat(e.edges))}));const o=e.selectAll(".edge").data(t,(e=>e.id)),a=o.enter().append("g").classed("edge",!0);o.exit().each((e=>e.state="removed")),a.each((e=>e.state="new")),o.each((e=>e.state="updated")),e.selectAll(".edge").filter((e=>"updated"===e.state)).each((function(e){s.select(this).selectAll(".edge-path").datum(e)})),e.selectAll(".edge").filter((e=>"new"===e.state)).call(this.renderEdgeAdded),e.selectAll(".edge").filter((e=>"updated"===e.state)).call(this.renderEdgeUpdated),e.selectAll(".edge").filter((e=>"removed"===e.state)).call(this.renderEdgeRemoved)}renderEdges(){const e=this.chart;e.selectAll(".edge").remove();const t=s=>{s.nodes&&s.nodes.forEach((e=>{t(e)})),s.edges&&e.selectAll(".edge").data(s.edges,(e=>e.id)).enter().append("g").classed("edge",!0)};t(this.layout),e.selectAll(".edge").call(this.renderEdge)}renderNodesDelta(){const e=this.chart,t=(e,o)=>{if(!o)return;const a=e.selectAll(".node").filter((function(){return this.parentNode===e.node()})).data(o,(e=>e.id)),l=a.enter().append("g").classed("node",!0);a.exit().each((e=>e.state="removed")),l.each((e=>e.state="new")),a.each((e=>e.state="updated")),[l,a].forEach((e=>{e.each((function(e){const o=s.select(this);0===o.select(".node-ui").size()&&o.append("g").classed("node-ui",!0),o.select(".node-ui").datum(e),0===o.select(".node-children").size()&&o.append("g").classed("node-children",!0),t(o.select(".node-children"),e.nodes)})),e.transition().duration(1e3).attr("transform",(e=>n.translate(e.x,e.y)))}))};t(e,this.layout.nodes),e.selectAll(".node-ui").filter((e=>"new"===e.state)).call(this.renderNodeAdded),e.selectAll(".node-ui").filter((e=>"updated"===e.state)).call(this.renderNodeUpdated),e.selectAll(".node-ui").filter((e=>"removed"===e.state)).call(this.renderNodeRemoved)}renderNodes(){const e=this.chart;e.selectAll(".node").remove();const t=(e,o)=>{if(!o)return;e.selectAll(".node").data(o).enter().append("g").classed("node",!0).attr("transform",(e=>n.translate(e.x,e.y))).each((function(e){const o=s.select(this);o.append("g").classed("node-ui",!0),t(o.append("g"),e.nodes)}))};t(e,this.layout.nodes),e.selectAll(".node-ui").call(this.renderNode)}calculateEdgeControlPlacement(e){const t=this.options;let s=0;const o=e.getTotalLength(),a=t.edgeControlOffset;s="percentage"===t.edgeControlOffsetType?a*o:a>0?a:Math.max(0,o+a);return e.getPointAtLength(s)}renderEdgeControls(){const e=this.chart,t=e.selectAll(".edge");t.selectAll(".edge-control").remove();const o=this;t.each((function(){const e=s.select(this).select("path").node(),t=o.calculateEdgeControlPlacement(e);s.select(this).append("g").classed("edge-control",!0).attr("transform",n.translate(t.x,t.y))})),e.selectAll(".edge-control").call(this.renderEdgeControl)}renderDebug(){const e=this.chart,t=this.options,o=this.chartSize,a=s.select(this.svgEl).select(".background-layer"),l=.5*(this.layout.width<o.width?o.width:this.layout.width),i=.5*(this.layout.height<o.height?o.height:this.layout.height),r=[[-5e3,i,5e3,i],[l,-5e3,l,5e3]];a.selectAll(".info").remove();const d=a.append("g").classed("info",!0),c=s.zoomTransform(e.node());d.append("text").text("TS: "+c.k.toFixed(2)),d.append("text").text("TX: "+c.x.toFixed(2)),d.append("text").text("TY: "+c.y.toFixed(2)),d.append("text").text("Mode: "+t.renderMode),d.selectAll("text").attr("x",3).attr("y",((e,t)=>14*(t+1))).style("font-size","10px"),a.selectAll(".grid").remove(),a.selectAll(".grid").data(r).enter().append("path").classed("grid",!0).attr("d",(e=>n.line(...e))).style("fill","none").style("stroke","#00F").style("stroke-width",1.5).style("opacity",.5)}async runLayout(){const e=this.adapter.makeRenderingGraph(this.data);return this.adapter.run(e)}highlight({nodes:e,edges:t},o){const n=s.select(this.svgEl),l=this.chart,i=o.color||"red",r=o.duration||2e3,d="glow"+(new Date).getTime(),c=n.select("defs").append("filter").attr("id",d).attr("width","200%").attr("filterUnits","userSpaceOnUse");c.append("feGaussianBlur").attr("stdDeviation",4.5).attr("result","blur"),c.append("feOffset").attr("in","blur").attr("result","offsetBlur").attr("dx",0).attr("dy",0).attr("x",-10).attr("y",-10),c.append("feFlood").attr("in","offsetBlur").attr("flood-color",i).attr("flood-opacity",.95).attr("result","offsetColor"),c.append("feComposite").attr("in","offsetColor").attr("in2","offsetBlur").attr("operator","in").attr("result","offsetBlur");const h=c.append("feMerge");h.append("feMergeNode").attr("in","offsetBlur"),h.append("feMergeNode").attr("in","SourceGraphic");const u=l.selectAll(".node").filter((t=>e.includes(t.id)));u.style("filter",`url(#${d})`).classed(""+d,!0);const g=l.selectAll(".edge").filter((e=>a.default.some(t,(t=>t.source===e.data.source&&t.target===e.data.target))));return g.style("filter",`url(#${d})`).classed(""+d,!0),n.select("#"+d).select("feGaussianBlur").transition().duration(r).attr("stdDeviation",0).on("end",(()=>{u.style("filter",null),g.style("filter",null)})),d}unHighlight(e){const t=s.select(this.svgEl);t.select("#"+e).remove(),t.selectAll("."+e).style("filter",null)}moveTo(e,t){const o=this.chart,n=this.chartSize,l=s.select(this.svgEl),i=this.layout.width<n.width?n.width:this.layout.width,d=this.layout.height<n.height?n.height:this.layout.height,c=s.zoomTransform(o.node()),h=r(this.layout).nodes.find((t=>t.id===e));if(a.default.isNil(h))return;let u=h.x,g=h.y,p=h;for(;p.parent&&0!==p.parent.depth;)p=p.parent,u+=p.x,g+=p.y,console.log(u,g);const f=u+.5*h.width,y=g+.5*h.height;l.transition().duration(t).call(this.zoom.transform,s.zoomIdentity.translate(0,0).scale(c.k).translate(-f+.5*i/c.k,-y+.5*d/c.k))}async collapse(e){const t=this.chart.selectAll(".node").filter((t=>t.id===e)).selectAll(".node").data().map((e=>e.id)),s=this.collapseTracker,o=this.hiddenEdges;s[e]={},s[e].edgeMap={},0!==t.length&&(i(this.layout,(n=>{if(n.id===e&&(n.width=40,n.height=40,s[e].nodes=n.nodes,n.nodes=[],n.collapsed=!0),!n.edges)return;const l=a.default.remove(n.edges,(e=>t.includes(e.source)&&t.includes(e.target)));a.default.isEmpty(l)||(o[n.id]=l);for(let o=0;o<n.edges.length;o++){const l=n.edges[o],i=l.source,r=l.target,d={};t.includes(i)&&(d.source=l.source,l.source=e),t.includes(r)&&(d.target=l.target,l.target=e),a.default.isEmpty(d)||(s[e].edgeMap[l.id]=d)}})),this.layout=await this.adapter.run(this.layout),this.render())}async expand(e){const t=this.chart.selectAll(".node").filter((t=>t.id===e)),s=this.collapseTracker,o=this.hiddenEdges,a=s[e];t.datum().nodes=a.nodes,t.datum().collapsed=!1,i(t.datum(),(e=>{({}).hasOwnProperty.call(o,e.id)&&!1===e.collapsed&&(e.edges=e.edges.concat(o[e.id]),delete o[e.id])})),i(this.layout,(e=>{if(e.edges)for(let t=0;t<e.edges.length;t++){const s=e.edges[t];a.edgeMap[s.id]&&(s.target=a.edgeMap[s.id].target||s.target,s.source=a.edgeMap[s.id].source||s.source)}})),delete s[e],this.layout=await this.adapter.run(this.layout),this.render()}async focus(e){const t=this.chart.selectAll(".node").filter((e=>!0===e.focused));if(1===t.size()){const e=t.datum();delete e.width,delete e.height,delete e.focused}const s=this.chart.selectAll(".node").filter((t=>t.id===e));s.nodes&&s.nodes.length>0||(s.datum().width=400,s.datum().height=300,s.datum().focused=!0,this.layout=await this.adapter.run(this.layout),this.render())}async unfocus(e){const t=this.chart.selectAll(".node").filter((t=>t.id===e)).datum();delete t.width,delete t.height,delete t.focused,this.layout=await this.adapter.run(this.layout),this.render()}async group(e,t){const s=this.chart.selectAll(".node").filter((e=>t.includes(e.id))).data();if(1!==a.default.uniq(s.map((e=>e.parent.id))).length)return void console.log("Cannot group across different levels");const o={id:e,label:e,concept:e,depth:s[0].depth,type:"custom",parent:s[0].parent,nodes:[],data:{label:e}},n=s[0].parent;t.forEach((e=>{const t={...a.default.remove(n.nodes,(t=>t.id===e))[0]};t.parent=o,o.nodes.push(t)})),n.nodes.push(o),this.layout=await this.adapter.run(this.layout),this.render()}async ungroup(e){const t=this.chart.selectAll(".node").filter((t=>t.id===e)).data()[0],s=t.parent;a.default.remove(s.nodes,(t=>t.id===e)),t.nodes.forEach((e=>{const t={...e};t.parent=s,s.nodes.push(t)})),delete t.nodes,this.layout=await this.adapter.run(this.layout),this.render()}boundary(){const e=this.chart,t=s.zoomTransform(e.node());return{x1:(0-t.x)/t.k,y1:(0-t.y)/t.k,x2:(this.layout.width-t.x)/t.k,y2:(this.layout.height-t.y)/t.k}}cullEdges(){const{x1:e,y1:t,x2:o,y2:n}=this.boundary();this.chart.selectAll(".edge").each((function(l){const i=a.default.first(l.points),r=a.default.last(l.points);(i.x<e||i.x>o||i.y<t||i.y>n)&&(r.x<e||r.x>o||r.y<t||r.y>n)&&s.select(this).style("opacity",0)}))}uncullEdges(){s.selectAll(".edge").style("opacity",1)}_createChart(){const{width:e,height:t}=this.chartSize,o={x1:0,y1:0,x2:this.layout.width,y2:this.layout.height},a=s.select(this.svgEl);a.selectAll("*").remove();const l=n.createChart(a,e,t,c(o,this.chartSize));l.attr("preserveAspectRatio","xMidYMid meet"),l.append("g").classed("background-layer",!0);const i=l.append("g").classed("data-layer",!0);l.append("g").classed("foreground-layer",!0);const r=this;const d=Math.max(2,Math.floor(this.layout.width/this.chartSize.width));return this.zoom=s.zoom().scaleExtent([.5,d]).on("zoom",(function(){i.attr("transform",s.event.transform),r.options.useDebugger&&r.renderDebug()})),a.call(this.zoom).on("dblclick.zoom",null),i}_enableInteraction(){const e=this.chart,t=this,o=this.registry,a=s.select(this.svgEl),n=e.selectAll(".node"),l=e.selectAll(".edge");t.clickTimer=null;const i=e=>({}.hasOwnProperty.call(o,e));a.on("click",(function(){s.event.stopPropagation();const e=s.zoomTransform(a.node()).invert(s.mouse(this));i("backgroundClick")&&o.backgroundClick(s.select(this),t,{x:e[0],y:e[1]})})),a.on("dblclick",(function(){s.event.stopPropagation();const e=s.zoomTransform(a.node()).invert(s.mouse(this));i("backgroundDblClick")&&o.backgroundDblClick(s.select(this),t,{x:e[0],y:e[1]})})),n.on("dblclick",(function(){s.event.stopPropagation(),i("nodeDblClick")&&(window.clearTimeout(t.clickTimer),o.nodeDblClick(s.select(this),t))})),n.on("click",(function(){if(s.event.stopPropagation(),i("nodeClick")){const e=this;window.clearTimeout(t.clickTimer),t.clickTimer=window.setTimeout((()=>{o.nodeClick(s.select(e),t)}),200)}})),n.on("mouseenter",(function(){s.event.stopPropagation(),i("nodeMouseEnter")&&o.nodeMouseEnter(s.select(this),t)})),n.on("mouseleave",(function(){s.event.stopPropagation(),i("nodeMouseLeave")&&o.nodeMouseLeave(s.select(this),t)})),l.on("click",(function(){s.event.stopPropagation(),i("edgeClick")&&o.edgeClick(s.select(this),t)})),l.on("mouseenter",(function(){s.event.stopPropagation(),i("edgeMouseEnter")&&o.edgeMouseEnter(s.select(this),t)})),l.on("mouseleave",(function(){s.event.stopPropagation(),i("edgeMouseLeave")&&o.edgeMouseLeave(s.select(this),t)}))}_enableDrag(){const e=this.chart,t=this.options,o=r(this.layout),a=e.selectAll(".node"),l=this;const i=s.drag().on("start",(function(){s.event.sourceEvent.stopPropagation()})).on("end",(function(){})).on("drag",(function(){const a=s.select(this),i=[a.datum().id,...a.selectAll(".node").data().map((e=>e.id))],r=s.select(this.parentNode).datum(),c=s.event.dx,h=s.event.dy;if(r){if(a.datum().x+a.datum().width+c>r.width||a.datum().x+c<0)return;if(a.datum().y+a.datum().height+h>r.height||a.datum().y+h<0)return}a.datum().x+=c,a.datum().y+=h,a.attr("transform",n.translate(a.datum().x,a.datum().y)),o.edges.forEach((e=>{const t=e.source,s=e.target;i.includes(t)&&i.includes(s)?e.points.forEach((e=>{e.x+=c,e.y+=h})):i.includes(t)?(e.points[0].x+=c,e.points[0].y+=h):i.includes(s)&&(e.points[e.points.length-1].x+=c,e.points[e.points.length-1].y+=h)})),e.selectAll(".edge").selectAll("path").attr("d",(e=>d(e.points))),t.useEdgeControl&&e.selectAll(".edge").each((function(){const e=s.select(this).select("path").node(),t=l.calculateEdgeControlPlacement(e);s.select(this).select(".edge-control").attr("transform",n.translate(t.x,t.y))}))}));a.call(i)}_trace(e){const t={},s=this.layout||{edges:[]},o=[];return function e(a){if({}.hasOwnProperty.call(t,a))return;t[a]=1,s.edges.filter((e=>e.data.target===a)).forEach((t=>{o.push(t),e(t.data.source)}))}(e),{edges:o.map((e=>({source:e.data.source,target:e.data.target}))),nodes:a.default.uniq([...o.map((e=>e.data.source)),...o.map((e=>e.data.target))])}}}}));
//# sourceMappingURL=compound-graph.min.js.map
