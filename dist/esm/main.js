import e from"lodash";import{line as t,curveBasis as n,select as r,zoomTransform as a,zoomIdentity as o,selectAll as i,zoom as s,event as c,mouse as l,drag as u}from"d3";function d(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function h(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){d(o,r,a,i,s,"next",e)}function s(e){d(o,r,a,i,s,"throw",e)}i(void 0)}))}}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){y(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function x(e,t){return(x=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function b(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=k(e);if(t){var a=k(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return w(this,n)}}function E(e,t,n){return(E="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=k(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function A(e){return function(e){if(Array.isArray(e))return O(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return O(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var C={createChart:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};e.attr("width",t+"px"),e.attr("height",n+"px");var a=r.x1||0,o=r.y1||0,i=r.x2||t,s=r.y2||n;return e.attr("preserveAspectRatio","xMinYMin meet"),e.attr("viewBox","".concat(a," ").concat(o," ").concat(i," ").concat(s)),e.append("defs"),e},translate:function(e,t){return"translate(".concat(e,", ").concat(t,")")},line:function(e,t,n,r){return"M"+e+","+t+"L"+n+","+r},pathFn:t().x((function(e){return e.x})).y((function(e){return e.y})),MARKER_VIEWBOX:"-5 -5 10 10",ARROW:"M 0,-3.25 L 5 ,0 L 0,3.25",ARROW_SHARP:"M 0,-3 L 5 ,0 L 0,3 L 1 0"},M=["backgroundClick","backgroundDblClick","backgroundMouseEnter","backgroundMouseLeave","backgroundCtx","nodeClick","nodeDblClick","nodeMouseEnter","nodeMouseLeave","nodeCtx","nodeSave","edgeClick","edgeMouseEnter","edgeMouseLeave","edgeCtx"],R=function(){function e(){f(this,e),this.data={},this.registry={}}return g(e,[{key:"setData",value:function(e){this.data=e}},{key:"setCallback",value:function(e,t){if(-1===M.indexOf(e))throw new Error("Failed to register callback, unknown name ".concat(e));this.registry[e]=t}},{key:"unsetCallback",value:function(e){delete this.registry[e]}},{key:"initialize",value:function(e){throw new Error("Needs impl")}},{key:"render",value:function(){throw new Error("Needs impl")}}]),e}(),P=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(n(t,r),t.nodes)for(var a=r+1,o=0;o<t.nodes.length;o++)e(t.nodes[o],n,a)},D=function(e){var t=[],n=[];return P(e,(function(e,r){r>0&&(t=t.concat(e)),e.edges&&(n=n.concat(e.edges))})),{nodes:t,edges:n}},S=C.pathFn.curve(n),j=function(e,t){return{x1:e.x1,y1:e.y1,x2:Math.max(e.x2,t.width),y2:Math.max(e.y2,t.height)}},z=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&x(e,t)}(T,R);var n,d,p,y,v,w,O,M,z=b(T);function T(e){var t;if(f(this,T),(t=z.call(this)).options=e||{},t.options.renderMode=t.options.renderMode||"basic",t.options.useEdgeControl=t.options.useEdgeControl||!1,t.options.edgeControlOffsetType=t.options.edgeControlOffsetType||"percentage",t.options.edgeControlOffset=t.options.edgeControlOffset||.66,t.options.useDebugger=t.options.useDebugger||!1,t.adapter=t.options.adapter,t.parentEl=null,t.svgEl=null,t.chart=null,t.chartSize={width:1,height:1},t.layout=null,!e.el)throw new Error("options must provide an element for graph rendering");return t.initialize(e.el),t.zoom=null,t.collapseTracker={},t.hiddenEdges={},t}return g(T,[{key:"initialize",value:function(e){this.parentEl=e,this.chartSize.width=this.parentEl.clientWidth,this.chartSize.height=this.parentEl.clientHeight,this.svgEl=document.createElementNS("http://www.w3.org/2000/svg","svg"),function(e){for(;e.firstChild;)e.removeChild(e.firstChild);return e}(this.parentEl).appendChild(this.svgEl),this.svgEl.style.userSelect="none"}},{key:"setData",value:function(e){E(k(T.prototype),"setData",this).call(this,e),this.layout=null}},{key:"render",value:(M=h(regeneratorRuntime.mark((function e(){var t,n,a,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.options,this.layout){e.next=5;break}return e.next=4,this.runLayout();case 4:this.layout=e.sent;case 5:this.chart?(n=this.layout.width,a=this.layout.height,i=j({x1:0,y1:0,x2:n,y2:a},this.chartSize),r(this.svgEl).attr("viewBox","".concat(i.x1," ").concat(i.y1," ").concat(i.x2," ").concat(i.y2)),r(this.svgEl).transition().call(this.zoom.transform,o),s=Math.max(2,Math.floor(this.layout.width/this.chartSize.width)),this.zoom.scaleExtent([.5,s])):this.chart=this._createChart(),this.buildDefs(),"basic"===t.renderMode?(this.renderNodes(),this.renderEdges()):(this.renderNodesDelta(),this.renderEdgesDelta()),t.useEdgeControl&&this.renderEdgeControls(),this._enableDrag(),t.useDebugger&&this.renderDebug(),this._enableInteraction();case 12:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"buildDefs",value:function(){var e=r(this.svgEl),t=D(this.layout).edges;e.select("defs").selectAll(".edge-marker-end").remove(),e.select("defs").selectAll(".edge-marker-end").data(t).enter().append("marker").classed("edge-marker-end",!0).attr("id",(function(e){var t=e.data.source.replace(/\s/g,""),n=e.data.target.replace(/\s/g,"");return"arrowhead-".concat(t,"-").concat(n)})).attr("viewBox",C.MARKER_VIEWBOX).attr("refX",2).attr("refY",0).attr("orient","auto").attr("markerWidth",15).attr("markerHeight",15).attr("markerUnits","userSpaceOnUse").attr("xoverflow","visible").append("svg:path").attr("d",C.ARROW).style("fill","#000").style("stroke","none")}},{key:"renderEdgesDelta",value:function(){var e=this.chart,t=[];P(this.layout,(function(e){e.edges&&e.edges.length>0&&(t=t.concat(e.edges))}));var n=e.selectAll(".edge").data(t,(function(e){return e.id})),a=n.enter().append("g").classed("edge",!0);n.exit().each((function(e){return e.state="removed"})),a.each((function(e){return e.state="new"})),n.each((function(e){return e.state="updated"})),e.selectAll(".edge").filter((function(e){return"updated"===e.state})).each((function(e){r(this).selectAll(".edge-path").datum(e)})),e.selectAll(".edge").filter((function(e){return"new"===e.state})).call(this.renderEdgeAdded),e.selectAll(".edge").filter((function(e){return"updated"===e.state})).call(this.renderEdgeUpdated),e.selectAll(".edge").filter((function(e){return"removed"===e.state})).call(this.renderEdgeRemoved)}},{key:"renderEdges",value:function(){var e=this.chart;e.selectAll(".edge").remove();!function t(n){n.nodes&&n.nodes.forEach((function(e){t(e)})),n.edges&&e.selectAll(".edge").data(n.edges,(function(e){return e.id})).enter().append("g").classed("edge",!0)}(this.layout),e.selectAll(".edge").call(this.renderEdge)}},{key:"renderNodesDelta",value:function(){var e=this.chart;!function e(t,n){if(n){var a=t.selectAll(".node").filter((function(){return this.parentNode===t.node()})).data(n,(function(e){return e.id})),o=a.enter().append("g").classed("node",!0);a.exit().each((function(e){return e.state="removed"})),o.each((function(e){return e.state="new"})),a.each((function(e){return e.state="updated"})),[o,a].forEach((function(t){t.each((function(t){var n=r(this);0===n.select(".node-ui").size()&&n.append("g").classed("node-ui",!0),n.select(".node-ui").datum(t),0===n.select(".node-children").size()&&n.append("g").classed("node-children",!0),e(n.select(".node-children"),t.nodes)})),t.transition().duration(1e3).attr("transform",(function(e){return C.translate(e.x,e.y)}))}))}}(e,this.layout.nodes),e.selectAll(".node-ui").filter((function(e){return"new"===e.state})).call(this.renderNodeAdded),e.selectAll(".node-ui").filter((function(e){return"updated"===e.state})).call(this.renderNodeUpdated),e.selectAll(".node-ui").filter((function(e){return"removed"===e.state})).call(this.renderNodeRemoved)}},{key:"renderNodes",value:function(){var e=this.chart;e.selectAll(".node").remove();!function e(t,n){n&&t.selectAll(".node").data(n).enter().append("g").classed("node",!0).attr("transform",(function(e){return C.translate(e.x,e.y)})).each((function(t){var n=r(this);n.append("g").classed("node-ui",!0),e(n.append("g"),t.nodes)}))}(e,this.layout.nodes),e.selectAll(".node-ui").call(this.renderNode)}},{key:"calculateEdgeControlPlacement",value:function(e){var t=this.options,n=0,r=e.getTotalLength(),a=t.edgeControlOffset;return n="percentage"===t.edgeControlOffsetType?a*r:a>0?a:Math.max(0,r+a),e.getPointAtLength(n)}},{key:"renderEdgeControls",value:function(){var e=this.chart,t=e.selectAll(".edge");t.selectAll(".edge-control").remove();var n=this;t.each((function(){var e=r(this).select("path").node(),t=n.calculateEdgeControlPlacement(e);r(this).append("g").classed("edge-control",!0).attr("transform",C.translate(t.x,t.y))})),e.selectAll(".edge-control").call(this.renderEdgeControl)}},{key:"renderDebug",value:function(){var e=this.chart,t=this.options,n=this.chartSize,o=r(this.svgEl).select(".background-layer"),i=.5*(this.layout.width<n.width?n.width:this.layout.width),s=.5*(this.layout.height<n.height?n.height:this.layout.height),c=[[-5e3,s,5e3,s],[i,-5e3,i,5e3]];o.selectAll(".info").remove();var l=o.append("g").classed("info",!0),u=a(e.node());l.append("text").text("TS: "+u.k.toFixed(2)),l.append("text").text("TX: "+u.x.toFixed(2)),l.append("text").text("TY: "+u.y.toFixed(2)),l.append("text").text("Mode: "+t.renderMode),l.selectAll("text").attr("x",3).attr("y",(function(e,t){return 14*(t+1)})).style("font-size","10px"),o.selectAll(".grid").remove(),o.selectAll(".grid").data(c).enter().append("path").classed("grid",!0).attr("d",(function(e){return C.line.apply(C,A(e))})).style("fill","none").style("stroke","#00F").style("stroke-width",1.5).style("opacity",.5)}},{key:"runLayout",value:(O=h(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.adapter.makeRenderingGraph(this.data),n=this.adapter.run(t),e.abrupt("return",n);case 3:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"highlight",value:function(t,n){var a=t.nodes,o=t.edges,i=r(this.svgEl),s=this.chart,c=n.color||"red",l=n.duration||2e3,u="glow".concat((new Date).getTime()),d=i.select("defs").append("filter").attr("id",u).attr("width","200%").attr("filterUnits","userSpaceOnUse");d.append("feGaussianBlur").attr("stdDeviation",4.5).attr("result","blur"),d.append("feOffset").attr("in","blur").attr("result","offsetBlur").attr("dx",0).attr("dy",0).attr("x",-10).attr("y",-10),d.append("feFlood").attr("in","offsetBlur").attr("flood-color",c).attr("flood-opacity",.95).attr("result","offsetColor"),d.append("feComposite").attr("in","offsetColor").attr("in2","offsetBlur").attr("operator","in").attr("result","offsetBlur");var h=d.append("feMerge");h.append("feMergeNode").attr("in","offsetBlur"),h.append("feMergeNode").attr("in","SourceGraphic");var f=s.selectAll(".node").filter((function(e){return a.includes(e.id)}));f.style("filter","url(#".concat(u,")")).classed("".concat(u),!0);var p=s.selectAll(".edge").filter((function(t){return e.some(o,(function(e){return e.source===t.data.source&&e.target===t.data.target}))}));return p.style("filter","url(#".concat(u,")")).classed("".concat(u),!0),i.select("#".concat(u)).select("feGaussianBlur").transition().duration(l).attr("stdDeviation",0).on("end",(function(){f.style("filter",null),p.style("filter",null)})),u}},{key:"unHighlight",value:function(e){var t=r(this.svgEl);t.select("#".concat(e)).remove(),t.selectAll(".".concat(e)).style("filter",null)}},{key:"moveTo",value:function(t,n){var i=this.chart,s=this.chartSize,c=r(this.svgEl),l=this.layout.width<s.width?s.width:this.layout.width,u=this.layout.height<s.height?s.height:this.layout.height,d=a(i.node()),h=D(this.layout).nodes.find((function(e){return e.id===t}));if(!e.isNil(h)){for(var f=h.x,p=h.y,g=h;g.parent&&0!==g.parent.depth;)f+=(g=g.parent).x,p+=g.y,console.log(f,p);var y=f+.5*h.width,v=p+.5*h.height;c.transition().duration(n).call(this.zoom.transform,o.translate(0,0).scale(d.k).translate(-y+.5*l/d.k,-v+.5*u/d.k))}}},{key:"collapse",value:(w=h(regeneratorRuntime.mark((function t(n){var r,a,o,i;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=this.chart.selectAll(".node").filter((function(e){return e.id===n})),a=r.selectAll(".node").data().map((function(e){return e.id})),o=this.collapseTracker,i=this.hiddenEdges,o[n]={},o[n].edgeMap={},0!==a.length){t.next=8;break}return t.abrupt("return");case 8:return P(this.layout,(function(t){if(t.id===n&&(t.width=40,t.height=40,o[n].nodes=t.nodes,t.nodes=[],t.collapsed=!0),t.edges){var r=e.remove(t.edges,(function(e){return a.includes(e.source)&&a.includes(e.target)}));e.isEmpty(r)||(i[t.id]=r);for(var s=0;s<t.edges.length;s++){var c=t.edges[s],l=c.source,u=c.target,d={};a.includes(l)&&(d.source=c.source,c.source=n),a.includes(u)&&(d.target=c.target,c.target=n),e.isEmpty(d)||(o[n].edgeMap[c.id]=d)}}})),t.next=11,this.adapter.run(this.layout);case 11:this.layout=t.sent,this.render();case 13:case"end":return t.stop()}}),t,this)}))),function(e){return w.apply(this,arguments)})},{key:"expand",value:(v=h(regeneratorRuntime.mark((function e(t){var n,r,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.chart.selectAll(".node").filter((function(e){return e.id===t})),r=this.collapseTracker,a=this.hiddenEdges,o=r[t],n.datum().nodes=o.nodes,n.datum().collapsed=!1,P(n.datum(),(function(e){({}).hasOwnProperty.call(a,e.id)&&!1===e.collapsed&&(e.edges=e.edges.concat(a[e.id]),delete a[e.id])})),P(this.layout,(function(e){if(e.edges)for(var t=0;t<e.edges.length;t++){var n=e.edges[t];o.edgeMap[n.id]&&(n.target=o.edgeMap[n.id].target||n.target,n.source=o.edgeMap[n.id].source||n.source)}})),delete r[t],e.next=11,this.adapter.run(this.layout);case 11:this.layout=e.sent,this.render();case 13:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"focus",value:(y=h(regeneratorRuntime.mark((function e(t){var n,r,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1===(n=this.chart.selectAll(".node").filter((function(e){return!0===e.focused}))).size()&&(delete(r=n.datum()).width,delete r.height,delete r.focused),!((a=this.chart.selectAll(".node").filter((function(e){return e.id===t}))).nodes&&a.nodes.length>0)){e.next=5;break}return e.abrupt("return");case 5:return a.datum().width=400,a.datum().height=300,a.datum().focused=!0,e.next=10,this.adapter.run(this.layout);case 10:this.layout=e.sent,this.render();case 12:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"unfocus",value:(p=h(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.chart.selectAll(".node").filter((function(e){return e.id===t})),delete(r=n.datum()).width,delete r.height,delete r.focused,e.next=7,this.adapter.run(this.layout);case 7:this.layout=e.sent,this.render();case 9:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"group",value:(d=h(regeneratorRuntime.mark((function t(n,r){var a,o,i,s;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=this.chart,o=a.selectAll(".node").filter((function(e){return r.includes(e.id)})).data(),1===e.uniq(o.map((function(e){return e.parent.id}))).length){t.next=5;break}return console.log("Cannot group across different levels"),t.abrupt("return");case 5:return i={id:n,label:n,concept:n,depth:o[0].depth,type:"custom",parent:o[0].parent,nodes:[],data:{label:n}},s=o[0].parent,r.forEach((function(t){var n=m({},e.remove(s.nodes,(function(e){return e.id===t}))[0]);n.parent=i,i.nodes.push(n)})),s.nodes.push(i),t.next=11,this.adapter.run(this.layout);case 11:this.layout=t.sent,this.render();case 13:case"end":return t.stop()}}),t,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"ungroup",value:(n=h(regeneratorRuntime.mark((function t(n){var r,a,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=this.chart,a=r.selectAll(".node").filter((function(e){return e.id===n})).data()[0],o=a.parent,e.remove(o.nodes,(function(e){return e.id===n})),a.nodes.forEach((function(e){var t=m({},e);t.parent=o,o.nodes.push(t)})),delete a.nodes,t.next=8,this.adapter.run(this.layout);case 8:this.layout=t.sent,this.render();case 10:case"end":return t.stop()}}),t,this)}))),function(e){return n.apply(this,arguments)})},{key:"boundary",value:function(){var e=this.chart,t=a(e.node());return{x1:(0-t.x)/t.k,y1:(0-t.y)/t.k,x2:(this.layout.width-t.x)/t.k,y2:(this.layout.height-t.y)/t.k}}},{key:"cullEdges",value:function(){var t=this.boundary(),n=t.x1,a=t.y1,o=t.x2,i=t.y2;this.chart.selectAll(".edge").each((function(t){var s=e.first(t.points),c=e.last(t.points);(s.x<n||s.x>o||s.y<a||s.y>i)&&(c.x<n||c.x>o||c.y<a||c.y>i)&&r(this).style("opacity",0)}))}},{key:"uncullEdges",value:function(){i(".edge").style("opacity",1)}},{key:"_createChart",value:function(){var e=this.chartSize,t=e.width,n=e.height,a={x1:0,y1:0,x2:this.layout.width,y2:this.layout.height},o=r(this.svgEl);o.selectAll("*").remove();var i=C.createChart(o,t,n,j(a,this.chartSize));i.attr("preserveAspectRatio","xMidYMid meet"),i.append("g").classed("background-layer",!0);var l=i.append("g").classed("data-layer",!0);i.append("g").classed("foreground-layer",!0);var u=this;var d=Math.max(2,Math.floor(this.layout.width/this.chartSize.width));return this.zoom=s().scaleExtent([.5,d]).on("zoom",(function(){l.attr("transform",c.transform),u.options.useDebugger&&u.renderDebug()})),o.call(this.zoom).on("dblclick.zoom",null),l}},{key:"_enableInteraction",value:function(){var e=this.chart,t=this,n=this.registry,o=r(this.svgEl),i=e.selectAll(".node"),s=e.selectAll(".edge");t.clickTimer=null;var u=function(e){return{}.hasOwnProperty.call(n,e)};o.on("click",(function(){c.stopPropagation();var e=a(o.node()).invert(l(this));u("backgroundClick")&&n.backgroundClick(r(this),t,{x:e[0],y:e[1]})})),o.on("dblclick",(function(){c.stopPropagation();var e=a(o.node()).invert(l(this));u("backgroundDblClick")&&n.backgroundDblClick(r(this),t,{x:e[0],y:e[1]})})),i.on("dblclick",(function(){c.stopPropagation(),u("nodeDblClick")&&(window.clearTimeout(t.clickTimer),n.nodeDblClick(r(this),t))})),i.on("click",(function(){if(c.stopPropagation(),u("nodeClick")){var e=this;window.clearTimeout(t.clickTimer),t.clickTimer=window.setTimeout((function(){n.nodeClick(r(e),t)}),200)}})),i.on("mouseenter",(function(){c.stopPropagation(),u("nodeMouseEnter")&&n.nodeMouseEnter(r(this),t)})),i.on("mouseleave",(function(){c.stopPropagation(),u("nodeMouseLeave")&&n.nodeMouseLeave(r(this),t)})),s.on("click",(function(){c.stopPropagation(),u("edgeClick")&&n.edgeClick(r(this),t)})),s.on("mouseenter",(function(){c.stopPropagation(),u("edgeMouseEnter")&&n.edgeMouseEnter(r(this),t)})),s.on("mouseleave",(function(){c.stopPropagation(),u("edgeMouseLeave")&&n.edgeMouseLeave(r(this),t)}))}},{key:"_enableDrag",value:function(){var e=this.chart,t=this.options,n=D(this.layout),a=e.selectAll(".node"),o=this;var i=u().on("start",(function(){c.sourceEvent.stopPropagation()})).on("end",(function(){})).on("drag",(function(){var a=r(this),i=[a.datum().id].concat(A(a.selectAll(".node").data().map((function(e){return e.id})))),s=r(this.parentNode).datum(),l=c.dx,u=c.dy;if(s){if(a.datum().x+a.datum().width+l>s.width||a.datum().x+l<0)return;if(a.datum().y+a.datum().height+u>s.height||a.datum().y+u<0)return}a.datum().x+=l,a.datum().y+=u,a.attr("transform",C.translate(a.datum().x,a.datum().y)),n.edges.forEach((function(e){var t=e.source,n=e.target;i.includes(t)&&i.includes(n)?e.points.forEach((function(e){e.x+=l,e.y+=u})):i.includes(t)?(e.points[0].x+=l,e.points[0].y+=u):i.includes(n)&&(e.points[e.points.length-1].x+=l,e.points[e.points.length-1].y+=u)})),e.selectAll(".edge").selectAll("path").attr("d",(function(e){return S(e.points)})),t.useEdgeControl&&e.selectAll(".edge").each((function(){var e=r(this).select("path").node(),t=o.calculateEdgeControlPlacement(e);r(this).select(".edge-control").attr("transform",C.translate(t.x,t.y))}))}));a.call(i)}},{key:"_trace",value:function(t){var n={},r=this.layout||{edges:[]},a=[];return function e(t){({}).hasOwnProperty.call(n,t)||(n[t]=1,r.edges.filter((function(e){return e.data.target===t})).forEach((function(t){a.push(t),e(t.data.source)})))}(t),{edges:a.map((function(e){return{source:e.data.source,target:e.data.target}})),nodes:e.uniq([].concat(A(a.map((function(e){return e.data.source}))),A(a.map((function(e){return e.data.target})))))}}}]),T}();export{z as SVGRenderer};
//# sourceMappingURL=main.js.map
