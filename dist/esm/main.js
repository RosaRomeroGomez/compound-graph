import e from"lodash";import{line as t,select as s,zoomIdentity as a,zoomTransform as o,selectAll as n,zoom as i,event as r,mouse as l,drag as d,curveBasis as c}from"d3";var h={createChart:(e,t,s,a={})=>{e.attr("width",t+"px"),e.attr("height",s+"px");const o=a.x1||0,n=a.y1||0,i=a.x2||t,r=a.y2||s;return e.attr("preserveAspectRatio","xMinYMin meet"),e.attr("viewBox",`${o} ${n} ${i} ${r}`),e.append("defs"),e},translate:(e,t)=>`translate(${e}, ${t})`,line:(e,t,s,a)=>"M"+e+","+t+"L"+s+","+a,pathFn:t().x((e=>e.x)).y((e=>e.y)),MARKER_VIEWBOX:"-5 -5 10 10",ARROW:"M 0,-3.25 L 5 ,0 L 0,3.25",ARROW_SHARP:"M 0,-3 L 5 ,0 L 0,3 L 1 0"};const u=["backgroundClick","backgroundDblClick","backgroundMouseEnter","backgroundMouseLeave","backgroundCtx","nodeClick","nodeDblClick","nodeMouseEnter","nodeMouseLeave","nodeCtx","nodeSave","edgeClick","edgeMouseEnter","edgeMouseLeave","edgeCtx"];const g=(e,t,s=0)=>{if(t(e,s),e.nodes){const a=s+1;for(let s=0;s<e.nodes.length;s++)g(e.nodes[s],t,a)}},p=e=>{let t=[],s=[];return g(e,((e,a)=>{a>0&&(t=t.concat(e)),e.edges&&(s=s.concat(e.edges))})),{nodes:t,edges:s}},f=h.pathFn.curve(c),y=(e,t)=>({x1:e.x1,y1:e.y1,x2:Math.max(e.x2,t.width),y2:Math.max(e.y2,t.height)});class m extends class{constructor(){this.data={},this.registry={}}setData(e){this.data=e}setCallback(e,t){if(-1===u.indexOf(e))throw new Error("Failed to register callback, unknown name "+e);this.registry[e]=t}unsetCallback(e){delete this.registry[e]}initialize(e){throw new Error("Needs impl")}render(){throw new Error("Needs impl")}}{constructor(e){if(super(),this.options=e||{},this.options.renderMode=this.options.renderMode||"basic",this.options.useEdgeControl=this.options.useEdgeControl||!1,this.options.edgeControlOffsetType=this.options.edgeControlOffsetType||"percentage",this.options.edgeControlOffset=this.options.edgeControlOffset||.66,this.options.useDebugger=this.options.useDebugger||!1,this.adapter=this.options.adapter,this.parentEl=null,this.svgEl=null,this.chart=null,this.chartSize={width:1,height:1},this.layout=null,!e.el)throw new Error("options must provide an element for graph rendering");this.initialize(e.el),this.zoom=null,this.collapseTracker={},this.hiddenEdges={}}initialize(e){this.parentEl=e,this.chartSize.width=this.parentEl.clientWidth,this.chartSize.height=this.parentEl.clientHeight,this.svgEl=document.createElementNS("http://www.w3.org/2000/svg","svg"),(e=>{for(;e.firstChild;)e.removeChild(e.firstChild);return e})(this.parentEl).appendChild(this.svgEl),this.svgEl.style.userSelect="none"}setData(e){super.setData(e),this.layout=null}async render(){const e=this.options;if(this.layout||(this.layout=await this.runLayout()),this.chart){const e=0,t=0,o=this.layout.width,n=this.layout.height,i=y({x1:e,y1:t,x2:o,y2:n},this.chartSize);s(this.svgEl).attr("viewBox",`${i.x1} ${i.y1} ${i.x2} ${i.y2}`);s(this.svgEl).transition().call(this.zoom.transform,a);const r=Math.max(2,Math.floor(this.layout.width/this.chartSize.width));this.zoom.scaleExtent([.5,r])}else this.chart=this._createChart();this.buildDefs(),"basic"===e.renderMode?(this.renderNodes(),this.renderEdges()):(this.renderNodesDelta(),this.renderEdgesDelta()),e.useEdgeControl&&this.renderEdgeControls(),this._enableDrag(),e.useDebugger&&this.renderDebug(),this._enableInteraction()}buildDefs(){const e=s(this.svgEl),t=p(this.layout).edges;e.select("defs").selectAll(".edge-marker-end").remove(),e.select("defs").selectAll(".edge-marker-end").data(t).enter().append("marker").classed("edge-marker-end",!0).attr("id",(e=>`arrowhead-${e.data.source.replace(/\s/g,"")}-${e.data.target.replace(/\s/g,"")}`)).attr("viewBox",h.MARKER_VIEWBOX).attr("refX",2).attr("refY",0).attr("orient","auto").attr("markerWidth",15).attr("markerHeight",15).attr("markerUnits","userSpaceOnUse").attr("xoverflow","visible").append("svg:path").attr("d",h.ARROW).style("fill","#000").style("stroke","none")}renderEdgesDelta(){const e=this.chart;let t=[];g(this.layout,(e=>{e.edges&&e.edges.length>0&&(t=t.concat(e.edges))}));const a=e.selectAll(".edge").data(t,(e=>e.id)),o=a.enter().append("g").classed("edge",!0);a.exit().each((e=>e.state="removed")),o.each((e=>e.state="new")),a.each((e=>e.state="updated")),e.selectAll(".edge").filter((e=>"updated"===e.state)).each((function(e){s(this).selectAll(".edge-path").datum(e)})),e.selectAll(".edge").filter((e=>"new"===e.state)).call(this.renderEdgeAdded),e.selectAll(".edge").filter((e=>"updated"===e.state)).call(this.renderEdgeUpdated),e.selectAll(".edge").filter((e=>"removed"===e.state)).call(this.renderEdgeRemoved)}renderEdges(){const e=this.chart;e.selectAll(".edge").remove();const t=s=>{s.nodes&&s.nodes.forEach((e=>{t(e)})),s.edges&&e.selectAll(".edge").data(s.edges,(e=>e.id)).enter().append("g").classed("edge",!0)};t(this.layout),e.selectAll(".edge").call(this.renderEdge)}renderNodesDelta(){const e=this.chart,t=(e,a)=>{if(!a)return;const o=e.selectAll(".node").filter((function(){return this.parentNode===e.node()})).data(a,(e=>e.id)),n=o.enter().append("g").classed("node",!0);o.exit().each((e=>e.state="removed")),n.each((e=>e.state="new")),o.each((e=>e.state="updated")),[n,o].forEach((e=>{e.each((function(e){const a=s(this);0===a.select(".node-ui").size()&&a.append("g").classed("node-ui",!0),a.select(".node-ui").datum(e),0===a.select(".node-children").size()&&a.append("g").classed("node-children",!0),t(a.select(".node-children"),e.nodes)})),e.transition().duration(1e3).attr("transform",(e=>h.translate(e.x,e.y)))}))};t(e,this.layout.nodes),e.selectAll(".node-ui").filter((e=>"new"===e.state)).call(this.renderNodeAdded),e.selectAll(".node-ui").filter((e=>"updated"===e.state)).call(this.renderNodeUpdated),e.selectAll(".node-ui").filter((e=>"removed"===e.state)).call(this.renderNodeRemoved)}renderNodes(){const e=this.chart;e.selectAll(".node").remove();const t=(e,a)=>{if(!a)return;e.selectAll(".node").data(a).enter().append("g").classed("node",!0).attr("transform",(e=>h.translate(e.x,e.y))).each((function(e){const a=s(this);a.append("g").classed("node-ui",!0),t(a.append("g"),e.nodes)}))};t(e,this.layout.nodes),e.selectAll(".node-ui").call(this.renderNode)}calculateEdgeControlPlacement(e){const t=this.options;let s=0;const a=e.getTotalLength(),o=t.edgeControlOffset;s="percentage"===t.edgeControlOffsetType?o*a:o>0?o:Math.max(0,a+o);return e.getPointAtLength(s)}renderEdgeControls(){const e=this.chart,t=e.selectAll(".edge");t.selectAll(".edge-control").remove();const a=this;t.each((function(){const e=s(this).select("path").node(),t=a.calculateEdgeControlPlacement(e);s(this).append("g").classed("edge-control",!0).attr("transform",h.translate(t.x,t.y))})),e.selectAll(".edge-control").call(this.renderEdgeControl)}renderDebug(){const e=this.chart,t=this.options,a=this.chartSize,n=s(this.svgEl).select(".background-layer"),i=.5*(this.layout.width<a.width?a.width:this.layout.width),r=.5*(this.layout.height<a.height?a.height:this.layout.height),l=[[-5e3,r,5e3,r],[i,-5e3,i,5e3]];n.selectAll(".info").remove();const d=n.append("g").classed("info",!0),c=o(e.node());d.append("text").text("TS: "+c.k.toFixed(2)),d.append("text").text("TX: "+c.x.toFixed(2)),d.append("text").text("TY: "+c.y.toFixed(2)),d.append("text").text("Mode: "+t.renderMode),d.selectAll("text").attr("x",3).attr("y",((e,t)=>14*(t+1))).style("font-size","10px"),n.selectAll(".grid").remove(),n.selectAll(".grid").data(l).enter().append("path").classed("grid",!0).attr("d",(e=>h.line(...e))).style("fill","none").style("stroke","#00F").style("stroke-width",1.5).style("opacity",.5)}async runLayout(){const e=this.adapter.makeRenderingGraph(this.data);return this.adapter.run(e)}highlight({nodes:t,edges:a},o){const n=s(this.svgEl),i=this.chart,r=o.color||"red",l=o.duration||2e3,d="glow"+(new Date).getTime(),c=n.select("defs").append("filter").attr("id",d).attr("width","200%").attr("filterUnits","userSpaceOnUse");c.append("feGaussianBlur").attr("stdDeviation",4.5).attr("result","blur"),c.append("feOffset").attr("in","blur").attr("result","offsetBlur").attr("dx",0).attr("dy",0).attr("x",-10).attr("y",-10),c.append("feFlood").attr("in","offsetBlur").attr("flood-color",r).attr("flood-opacity",.95).attr("result","offsetColor"),c.append("feComposite").attr("in","offsetColor").attr("in2","offsetBlur").attr("operator","in").attr("result","offsetBlur");const h=c.append("feMerge");h.append("feMergeNode").attr("in","offsetBlur"),h.append("feMergeNode").attr("in","SourceGraphic");const u=i.selectAll(".node").filter((e=>t.includes(e.id)));u.style("filter",`url(#${d})`).classed(""+d,!0);const g=i.selectAll(".edge").filter((t=>e.some(a,(e=>e.source===t.data.source&&e.target===t.data.target))));return g.style("filter",`url(#${d})`).classed(""+d,!0),n.select("#"+d).select("feGaussianBlur").transition().duration(l).attr("stdDeviation",0).on("end",(()=>{u.style("filter",null),g.style("filter",null)})),d}unHighlight(e){const t=s(this.svgEl);t.select("#"+e).remove(),t.selectAll("."+e).style("filter",null)}moveTo(t,n){const i=this.chart,r=this.chartSize,l=s(this.svgEl),d=this.layout.width<r.width?r.width:this.layout.width,c=this.layout.height<r.height?r.height:this.layout.height,h=o(i.node()),u=p(this.layout).nodes.find((e=>e.id===t));if(e.isNil(u))return;let g=u.x,f=u.y,y=u;for(;y.parent&&0!==y.parent.depth;)y=y.parent,g+=y.x,f+=y.y,console.log(g,f);const m=g+.5*u.width,x=f+.5*u.height;l.transition().duration(n).call(this.zoom.transform,a.translate(0,0).scale(h.k).translate(-m+.5*d/h.k,-x+.5*c/h.k))}async collapse(t){const s=this.chart.selectAll(".node").filter((e=>e.id===t)).selectAll(".node").data().map((e=>e.id)),a=this.collapseTracker,o=this.hiddenEdges;a[t]={},a[t].edgeMap={},0!==s.length&&(g(this.layout,(n=>{if(n.id===t&&(n.width=40,n.height=40,a[t].nodes=n.nodes,n.nodes=[],n.collapsed=!0),!n.edges)return;const i=e.remove(n.edges,(e=>s.includes(e.source)&&s.includes(e.target)));e.isEmpty(i)||(o[n.id]=i);for(let o=0;o<n.edges.length;o++){const i=n.edges[o],r=i.source,l=i.target,d={};s.includes(r)&&(d.source=i.source,i.source=t),s.includes(l)&&(d.target=i.target,i.target=t),e.isEmpty(d)||(a[t].edgeMap[i.id]=d)}})),this.layout=await this.adapter.run(this.layout),this.render())}async expand(e){const t=this.chart.selectAll(".node").filter((t=>t.id===e)),s=this.collapseTracker,a=this.hiddenEdges,o=s[e];t.datum().nodes=o.nodes,t.datum().collapsed=!1,g(t.datum(),(e=>{({}).hasOwnProperty.call(a,e.id)&&!1===e.collapsed&&(e.edges=e.edges.concat(a[e.id]),delete a[e.id])})),g(this.layout,(e=>{if(e.edges)for(let t=0;t<e.edges.length;t++){const s=e.edges[t];o.edgeMap[s.id]&&(s.target=o.edgeMap[s.id].target||s.target,s.source=o.edgeMap[s.id].source||s.source)}})),delete s[e],this.layout=await this.adapter.run(this.layout),this.render()}async focus(e){const t=this.chart.selectAll(".node").filter((e=>!0===e.focused));if(1===t.size()){const e=t.datum();delete e.width,delete e.height,delete e.focused}const s=this.chart.selectAll(".node").filter((t=>t.id===e));s.nodes&&s.nodes.length>0||(s.datum().width=400,s.datum().height=300,s.datum().focused=!0,this.layout=await this.adapter.run(this.layout),this.render())}async unfocus(e){const t=this.chart.selectAll(".node").filter((t=>t.id===e)).datum();delete t.width,delete t.height,delete t.focused,this.layout=await this.adapter.run(this.layout),this.render()}async group(t,s){const a=this.chart.selectAll(".node").filter((e=>s.includes(e.id))).data();if(1!==e.uniq(a.map((e=>e.parent.id))).length)return void console.log("Cannot group across different levels");const o={id:t,label:t,concept:t,depth:a[0].depth,type:"custom",parent:a[0].parent,nodes:[],data:{label:t}},n=a[0].parent;s.forEach((t=>{const s={...e.remove(n.nodes,(e=>e.id===t))[0]};s.parent=o,o.nodes.push(s)})),n.nodes.push(o),this.layout=await this.adapter.run(this.layout),this.render()}async ungroup(t){const s=this.chart.selectAll(".node").filter((e=>e.id===t)).data()[0],a=s.parent;e.remove(a.nodes,(e=>e.id===t)),s.nodes.forEach((e=>{const t={...e};t.parent=a,a.nodes.push(t)})),delete s.nodes,this.layout=await this.adapter.run(this.layout),this.render()}boundary(){const e=this.chart,t=o(e.node());return{x1:(0-t.x)/t.k,y1:(0-t.y)/t.k,x2:(this.layout.width-t.x)/t.k,y2:(this.layout.height-t.y)/t.k}}cullEdges(){const{x1:t,y1:a,x2:o,y2:n}=this.boundary();this.chart.selectAll(".edge").each((function(i){const r=e.first(i.points),l=e.last(i.points);(r.x<t||r.x>o||r.y<a||r.y>n)&&(l.x<t||l.x>o||l.y<a||l.y>n)&&s(this).style("opacity",0)}))}uncullEdges(){n(".edge").style("opacity",1)}_createChart(){const{width:e,height:t}=this.chartSize,a={x1:0,y1:0,x2:this.layout.width,y2:this.layout.height},o=s(this.svgEl);o.selectAll("*").remove();const n=h.createChart(o,e,t,y(a,this.chartSize));n.attr("preserveAspectRatio","xMidYMid meet"),n.append("g").classed("background-layer",!0);const l=n.append("g").classed("data-layer",!0);n.append("g").classed("foreground-layer",!0);const d=this;const c=Math.max(2,Math.floor(this.layout.width/this.chartSize.width));return this.zoom=i().scaleExtent([.5,c]).on("zoom",(function(){l.attr("transform",r.transform),d.options.useDebugger&&d.renderDebug()})),o.call(this.zoom).on("dblclick.zoom",null),l}_enableInteraction(){const e=this.chart,t=this,a=this.registry,n=s(this.svgEl),i=e.selectAll(".node"),d=e.selectAll(".edge");t.clickTimer=null;const c=e=>({}.hasOwnProperty.call(a,e));n.on("click",(function(){r.stopPropagation();const e=o(n.node()).invert(l(this));c("backgroundClick")&&a.backgroundClick(s(this),t,{x:e[0],y:e[1]})})),n.on("dblclick",(function(){r.stopPropagation();const e=o(n.node()).invert(l(this));c("backgroundDblClick")&&a.backgroundDblClick(s(this),t,{x:e[0],y:e[1]})})),i.on("dblclick",(function(){r.stopPropagation(),c("nodeDblClick")&&(window.clearTimeout(t.clickTimer),a.nodeDblClick(s(this),t))})),i.on("click",(function(){if(r.stopPropagation(),c("nodeClick")){const e=this;window.clearTimeout(t.clickTimer),t.clickTimer=window.setTimeout((()=>{a.nodeClick(s(e),t)}),200)}})),i.on("mouseenter",(function(){r.stopPropagation(),c("nodeMouseEnter")&&a.nodeMouseEnter(s(this),t)})),i.on("mouseleave",(function(){r.stopPropagation(),c("nodeMouseLeave")&&a.nodeMouseLeave(s(this),t)})),d.on("click",(function(){r.stopPropagation(),c("edgeClick")&&a.edgeClick(s(this),t)})),d.on("mouseenter",(function(){r.stopPropagation(),c("edgeMouseEnter")&&a.edgeMouseEnter(s(this),t)})),d.on("mouseleave",(function(){r.stopPropagation(),c("edgeMouseLeave")&&a.edgeMouseLeave(s(this),t)}))}_enableDrag(){const e=this.chart,t=this.options,a=p(this.layout),o=e.selectAll(".node"),n=this;const i=d().on("start",(function(){r.sourceEvent.stopPropagation()})).on("end",(function(){})).on("drag",(function(){const o=s(this),i=[o.datum().id,...o.selectAll(".node").data().map((e=>e.id))],l=s(this.parentNode).datum(),d=r.dx,c=r.dy;if(l){if(o.datum().x+o.datum().width+d>l.width||o.datum().x+d<0)return;if(o.datum().y+o.datum().height+c>l.height||o.datum().y+c<0)return}o.datum().x+=d,o.datum().y+=c,o.attr("transform",h.translate(o.datum().x,o.datum().y)),a.edges.forEach((e=>{const t=e.source,s=e.target;i.includes(t)&&i.includes(s)?e.points.forEach((e=>{e.x+=d,e.y+=c})):i.includes(t)?(e.points[0].x+=d,e.points[0].y+=c):i.includes(s)&&(e.points[e.points.length-1].x+=d,e.points[e.points.length-1].y+=c)})),e.selectAll(".edge").selectAll("path").attr("d",(e=>f(e.points))),t.useEdgeControl&&e.selectAll(".edge").each((function(){const e=s(this).select("path").node(),t=n.calculateEdgeControlPlacement(e);s(this).select(".edge-control").attr("transform",h.translate(t.x,t.y))}))}));o.call(i)}_trace(t){const s={},a=this.layout||{edges:[]},o=[];return function e(t){if({}.hasOwnProperty.call(s,t))return;s[t]=1,a.edges.filter((e=>e.data.target===t)).forEach((t=>{o.push(t),e(t.data.source)}))}(t),{edges:o.map((e=>({source:e.data.source,target:e.data.target}))),nodes:e.uniq([...o.map((e=>e.data.source)),...o.map((e=>e.data.target))])}}}export{m as SVGRenderer};
//# sourceMappingURL=main.js.map
